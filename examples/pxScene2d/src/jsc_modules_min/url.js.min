'use strict';var toASCII=require("punycode").toASCII;exports.parse=urlParse,exports.resolve=urlResolve,exports.resolveObject=urlResolveObject,exports.format=urlFormat,exports.Url=Url;function Url(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}const protocolPattern=/^([a-z0-9.+-]+:)/i,portPattern=/:[0-9]*$/,simplePathPattern=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,hostnameMaxLen=255,unsafeProtocol={javascript:!0,"javascript:":!0},hostlessProtocol={javascript:!0,"javascript:":!0},slashedProtocol={http:!0,"http:":!0,https:!0,"https:":!0,ftp:!0,"ftp:":!0,gopher:!0,"gopher:":!0,file:!0,"file:":!0},querystring=require("querystring.js");function ParsedQueryString(){}ParsedQueryString.prototype=Object.create(null);function urlParse(a,b,c){if(a instanceof Url)return a;var d=new Url;return d.parse(a,b,c),d}Url.prototype.parse=function(a,b,c){if("string"!=typeof a)throw new TypeError("Parameter \"url\" must be a string, not "+typeof a);for(var d=!1,e=-1,f=-1,g="",j=0,k=0,l=!1,m=!1;k<a.length;++k){const b=a.charCodeAt(k),c=32===b||9===b||13===b||10===b||12===b||160===b||65279===b;if(-1===e){if(c)continue;j=e=k}else l?!c&&(f=-1,l=!1):c&&(f=k,l=!0);if(!m)switch(b){case 35:d=!0;case 63:m=!0;break;case 92:0<k-j&&(g+=a.slice(j,k)),g+="/",j=k+1;}else d||35!==b||(d=!0)}if(-1!==e&&(j===e?-1===f?0===e?g=a:g=a.slice(e):g=a.slice(e,f):-1===f&&j<a.length?g+=a.slice(j):-1!==f&&j<f&&(g+=a.slice(j,f))),!c&&!d){const a=simplePathPattern.exec(g);if(a)return this.path=g,this.href=g,this.pathname=a[1],a[2]?(this.search=a[2],this.query=b?querystring.parse(this.search.slice(1)):this.search.slice(1)):b&&(this.search="",this.query=new ParsedQueryString),this}var n=protocolPattern.exec(g);if(n){n=n[0];var o=n.toLowerCase();this.protocol=o,g=g.slice(n.length)}if(c||n||/^\/\/[^@\/]+@[^@\/]+/.test(g)){var q=47===g.charCodeAt(0)&&47===g.charCodeAt(1);q&&!(n&&hostlessProtocol[n])&&(g=g.slice(2),this.slashes=!0)}if(!hostlessProtocol[n]&&(q||n&&!slashedProtocol[n])){var r=-1,s=-1,t=-1;for(k=0;k<g.length;++k){switch(g.charCodeAt(k)){case 9:case 10:case 13:case 32:case 34:case 37:case 39:case 59:case 60:case 62:case 92:case 94:case 96:case 123:case 124:case 125:-1===t&&(t=k);break;case 35:case 47:case 63:-1===t&&(t=k),r=k;break;case 64:s=k,t=-1;}if(-1!==r)break}e=0,-1!==s&&(this.auth=decodeURIComponent(g.slice(0,s)),e=s+1),-1===t?(this.host=g.slice(e),g=""):(this.host=g.slice(e,t),g=g.slice(t)),this.parseHost(),"string"!=typeof this.hostname&&(this.hostname="");var u=this.hostname,v=91===u.charCodeAt(0)&&93===u.charCodeAt(u.length-1);if(!v){const a=validateHostname(this,g,u);void 0!==a&&(g=a)}this.hostname=this.hostname.length>hostnameMaxLen?"":this.hostname.toLowerCase(),v||(this.hostname=toASCII(this.hostname));var w=this.port?":"+this.port:"",p=this.hostname||"";this.host=p+w,v&&(this.hostname=this.hostname.slice(1,-1),"/"!==g[0]&&(g="/"+g))}if(!unsafeProtocol[o]){const a=autoEscapeStr(g);void 0!==a&&(g=a)}var h=-1,x=-1;for(k=0;k<g.length;++k){const a=g.charCodeAt(k);if(35===a){this.hash=g.slice(k),x=k;break}else 63===a&&-1===h&&(h=k)}-1===h?b&&(this.search="",this.query=new ParsedQueryString):(-1===x?(this.search=g.slice(h),this.query=g.slice(h+1)):(this.search=g.slice(h,x),this.query=g.slice(h+1,x)),b&&(this.query=querystring.parse(this.query)));var y=-1!==h&&(-1===x||h<x)?h:x;if(-1===y?0<g.length&&(this.pathname=g):0<y&&(this.pathname=g.slice(0,y)),slashedProtocol[o]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){const a=this.pathname||"",b=this.search||"";this.path=a+b}return this.href=this.format(),this};function validateHostname(a,b,c){for(var d,e=0;e<=c.length;++e){var f;if(e<c.length&&(f=c.charCodeAt(e)),46===f||e===c.length){if(0<e-d&&63<e-d)return a.hostname=c.slice(0,d+63),"/"+c.slice(d+63)+b;d=e+1;continue}else if(48<=f&&57>=f||97<=f&&122>=f||45===f||65<=f&&90>=f||43===f||95===f||127<f)continue;if(a.hostname=c.slice(0,e),e<c.length)return"/"+c.slice(e)+b;break}}function autoEscapeStr(a){for(var b="",c=0,d=0;d<a.length;++d)switch(a.charCodeAt(d)){case 9:0<d-c&&(b+=a.slice(c,d)),b+="%09",c=d+1;break;case 10:0<d-c&&(b+=a.slice(c,d)),b+="%0A",c=d+1;break;case 13:0<d-c&&(b+=a.slice(c,d)),b+="%0D",c=d+1;break;case 32:0<d-c&&(b+=a.slice(c,d)),b+="%20",c=d+1;break;case 34:0<d-c&&(b+=a.slice(c,d)),b+="%22",c=d+1;break;case 39:0<d-c&&(b+=a.slice(c,d)),b+="%27",c=d+1;break;case 60:0<d-c&&(b+=a.slice(c,d)),b+="%3C",c=d+1;break;case 62:0<d-c&&(b+=a.slice(c,d)),b+="%3E",c=d+1;break;case 92:0<d-c&&(b+=a.slice(c,d)),b+="%5C",c=d+1;break;case 94:0<d-c&&(b+=a.slice(c,d)),b+="%5E",c=d+1;break;case 96:0<d-c&&(b+=a.slice(c,d)),b+="%60",c=d+1;break;case 123:0<d-c&&(b+=a.slice(c,d)),b+="%7B",c=d+1;break;case 124:0<d-c&&(b+=a.slice(c,d)),b+="%7C",c=d+1;break;case 125:0<d-c&&(b+=a.slice(c,d)),b+="%7D",c=d+1;}return 0===c?void 0:c<a.length?b+a.slice(c):b}function urlFormat(a){if("string"==typeof a)a=urlParse(a);else if("object"!=typeof a||null===a)throw new TypeError(null==="Parameter \"urlObj\" must be an object, not "+a?"null":typeof a);else if(!(a instanceof Url))return Url.prototype.format.call(a);return a.format()}Url.prototype.format=function(){var a=this.auth||"";a&&(a=encodeAuth(a),a+="@");var b=this.protocol||"",c=this.pathname||"",d=this.hash||"",e=!1,f="";this.host?e=a+this.host:this.hostname&&(e=a+(-1===this.hostname.indexOf(":")?this.hostname:"["+this.hostname+"]"),this.port&&(e+=":"+this.port)),null!==this.query&&"object"==typeof this.query&&(f=querystring.stringify(this.query));var g=this.search||f&&"?"+f||"";b&&58!==b.charCodeAt(b.length-1)&&(b+=":");for(var h="",j=0,k=0;k<c.length;++k)switch(c.charCodeAt(k)){case 35:0<k-j&&(h+=c.slice(j,k)),h+="%23",j=k+1;break;case 63:0<k-j&&(h+=c.slice(j,k)),h+="%3F",j=k+1;}return 0<j&&(j===c.length?c=h:c=h+c.slice(j)),this.slashes||(!b||slashedProtocol[b])&&!1!==e?(e="//"+(e||""),c&&47!==c.charCodeAt(0)&&(c="/"+c)):!e&&(e=""),g=g.replace(/#/g,"%23"),d&&35!==d.charCodeAt(0)&&(d="#"+d),g&&63!==g.charCodeAt(0)&&(g="?"+g),b+e+c+g+d};function urlResolve(a,b){return urlParse(a,!1,!0).resolve(b)}Url.prototype.resolve=function(a){return this.resolveObject(urlParse(a,!1,!0)).format()};function urlResolveObject(a,b){return a?urlParse(a,!1,!0).resolveObject(b):b}Url.prototype.resolveObject=function(a){if("string"==typeof a){var b=new Url;b.parse(a,!1,!0),a=b}for(var c,d=new Url,e=Object.keys(this),f=0;f<e.length;f++)c=e[f],d[c]=this[c];if(d.hash=a.hash,""===a.href)return d.href=d.format(),d;if(a.slashes&&!a.protocol){for(var g,h=Object.keys(a),j=0;j<h.length;j++)g=h[j],"protocol"!==g&&(d[g]=a[g]);return slashedProtocol[d.protocol]&&d.hostname&&!d.pathname&&(d.path=d.pathname="/"),d.href=d.format(),d}if(a.protocol&&a.protocol!==d.protocol){if(!slashedProtocol[a.protocol]){for(var l,m=Object.keys(a),n=0;n<m.length;n++)l=m[n],d[l]=a[l];return d.href=d.format(),d}if(d.protocol=a.protocol,!a.host&&!/^file:?$/.test(a.protocol)&&!hostlessProtocol[a.protocol]){const b=(a.pathname||"").split("/");for(;b.length&&!(a.host=b.shift()););a.host||(a.host=""),a.hostname||(a.hostname=""),""!==b[0]&&b.unshift(""),2>b.length&&b.unshift(""),d.pathname=b.join("/")}else d.pathname=a.pathname;if(d.search=a.search,d.query=a.query,d.host=a.host||"",d.auth=a.auth,d.hostname=a.hostname||a.host,d.port=a.port,d.pathname||d.search){var o=d.pathname||"",p=d.search||"";d.path=o+p}return d.slashes=d.slashes||a.slashes,d.href=d.format(),d}var q=d.pathname&&"/"===d.pathname.charAt(0),r=a.host||a.pathname&&"/"===a.pathname.charAt(0),s=r||q||d.host&&a.pathname,t=s,u=d.pathname&&d.pathname.split("/")||[],w=a.pathname&&a.pathname.split("/")||[],x=d.protocol&&!slashedProtocol[d.protocol];if(x&&(d.hostname="",d.port=null,d.host&&(""===u[0]?u[0]=d.host:u.unshift(d.host)),d.host="",a.protocol&&(a.hostname=null,a.port=null,d.auth=null,a.host&&(""===w[0]?w[0]=a.host:w.unshift(a.host)),a.host=null),s=s&&(""===w[0]||""===u[0])),r)(a.host||""===a.host)&&(d.host!==a.host&&(d.auth=null),d.host=a.host,d.port=a.port),(a.hostname||""===a.hostname)&&(d.hostname!==a.hostname&&(d.auth=null),d.hostname=a.hostname),d.search=a.search,d.query=a.query,u=w;else if(w.length)u||(u=[]),u.pop(),u=u.concat(w),d.search=a.search,d.query=a.query;else if(null!==a.search&&void 0!==a.search){if(x){d.hostname=d.host=u.shift();const a=!!(d.host&&0<d.host.indexOf("@"))&&d.host.split("@");a&&(d.auth=a.shift(),d.host=d.hostname=a.shift())}return d.search=a.search,d.query=a.query,(null!==d.pathname||null!==d.search)&&(d.path=(d.pathname?d.pathname:"")+(d.search?d.search:"")),d.href=d.format(),d}if(!u.length)return d.pathname=null,d.path=d.search?"/"+d.search:null,d.href=d.format(),d;for(var y=u.slice(-1)[0],z=(d.host||a.host||1<u.length)&&("."===y||".."===y)||""===y,A=0,B=u.length-1;0<=B;B--)y=u[B],"."===y?spliceOne(u,B):".."===y?(spliceOne(u,B),A++):A&&(spliceOne(u,B),A--);if(!s&&!t)for(;A--;A)u.unshift("..");s&&""!==u[0]&&(!u[0]||"/"!==u[0].charAt(0))&&u.unshift(""),z&&"/"!==u.join("/").substr(-1)&&u.push("");var C=""===u[0]||u[0]&&"/"===u[0].charAt(0);if(x){d.hostname=d.host=C?"":u.length?u.shift():"";const a=!!(d.host&&0<d.host.indexOf("@"))&&d.host.split("@");a&&(d.auth=a.shift(),d.host=d.hostname=a.shift())}return s=s||d.host&&u.length,s&&!C&&u.unshift(""),u.length?d.pathname=u.join("/"):(d.pathname=null,d.path=null),(null!==d.pathname||null!==d.search)&&(d.path=(d.pathname?d.pathname:"")+(d.search?d.search:"")),d.auth=a.auth||d.auth,d.slashes=d.slashes||a.slashes,d.href=d.format(),d},Url.prototype.parseHost=function(){var a=this.host,b=portPattern.exec(a);b&&(b=b[0],":"!==b&&(this.port=b.slice(1)),a=a.slice(0,a.length-b.length)),a&&(this.hostname=a)};function spliceOne(a,b){for(var c=b,d=c+1,e=a.length;d<e;c+=1,d+=1)a[c]=a[d];a.pop()}for(var hexTable=Array(256),i=0;256>i;++i)hexTable[i]="%"+((16>i?"0":"")+i.toString(16)).toUpperCase();function encodeAuth(a){for(var b,d="",e=0,f=0;f<a.length;++f)if(b=a.charCodeAt(f),!(33===b||45===b||46===b||95===b||126===b||39<=b&&42>=b||48<=b&&58>=b||65<=b&&90>=b||97<=b&&122>=b)){if(0<f-e&&(d+=a.slice(e,f)),e=f+1,128>b){d+=hexTable[b];continue}if(2048>b){d+=hexTable[192|b>>6]+hexTable[128|63&b];continue}if(55296>b||57344<=b){d+=hexTable[224|b>>12]+hexTable[128|63&b>>6]+hexTable[128|63&b];continue}++f;var g;g=f<a.length?1023&a.charCodeAt(f):0,b=65536+((1023&b)<<10|g),d+=hexTable[240|b>>18]+hexTable[128|63&b>>12]+hexTable[128|63&b>>6]+hexTable[128|63&b]}return 0===e?a:e<a.length?d+a.slice(e):d}