'use strict';var scene,root,applicationsArray=[],availableApplicationsArray=[],eventListenerHash={},appManager=new Optimus;module.exports=appManager;var ApplicationType=Object.freeze({SPARK:"SPARK",SPARK_INSTANCE:"SPARK_INSTANCE",NATIVE:"NATIVE",WEB:"WEB",UNDEFINED:"UNDEFINED"}),ApplicationState=Object.freeze({RUNNING:"RUNNING",SUSPENDED:"SUSPENDED",DESTROYED:"DESTROYED"});function Application(a){var b={x:"x",y:"y",w:"w",h:"h",cx:"cx",cy:"cy",sx:"sx",sy:"sy",r:"r",a:"a",interactive:"interactive",painting:"painting",clip:"clip",mask:"mask",draw:"draw",hasApi:"hasApi",url:"url"},c={pid:"clientPID"},d=this;Object.keys(b).forEach(function(a){Object.defineProperty(d,a,{get:function(){return i[b[a]]},set:function(c){this.type===ApplicationType.SPARK_INSTANCE&&i.api&&"url"===a&&(i.api.url=c),i[b[a]]=c}})}),Object.keys(c).forEach(function(a){Object.defineProperty(d,a,{get:function(){return i[c[a]]}})}),this.id=void 0,this.priority=1,this.name="",this.createTime=0,this.uri="",this.type=ApplicationType.UNDEFINED;var e=void 0,f=void 0;this.ready=new Promise(function(a,b){e=a,f=b});var g,i,j,k="",l=0,m=0,n="",o={},p=ApplicationState.RUNNING;this.suspend=function(a){var b;return p===ApplicationState.DESTROYED?(this.log("suspend on already destroyed app"),!1):p===ApplicationState.SUSPENDED?(this.log("suspend on already suspended app"),!1):i&&i.suspend?(b=i.suspend(a),!0===b?(p=ApplicationState.SUSPENDED,this.applicationSuspended()):this.log("suspend returned:",b),b):(this.log("suspend api not available on app"),p=ApplicationState.SUSPENDED,this.applicationSuspended(),!1)},this.resume=function(a){var b;return p===ApplicationState.DESTROYED?(this.log("resume on already destroyed app"),!1):p===ApplicationState.RUNNING?(this.log("resume on already running app"),!1):i&&i.resume?(b=i.resume(a),!0===b?(p=ApplicationState.RUNNING,this.applicationResumed()):this.log("resume returned:",b),b):(this.log("resume api not available on app"),p=ApplicationState.RUNNING,this.applicationResumed(),!1)},this.destroy=function(){var a=!1;if(p===ApplicationState.DESTROYED)return this.log("destroy on already destroyed app"),!1;if(!i||!i.destroy&&!i.dispose)return this.log("destroy not supported"),!1;try{this.log("about to remove"),i.remove&&i.remove()}catch(a){this.log("failed to remove",a)}try{this.log("about to destroy"),i.destroy?a=i.destroy():this.type===ApplicationType.SPARK&&i.api&&i.api.destroy?a=i.api.destroy():i.dispose&&(i.dispose(),a=!0)}catch(a){this.log("failed to destroy",a)}return!0===a?(i=null,p=ApplicationState.DESTROYED,this.applicationDestroyed()):this.log("destroy returned:",a),a},this.moveToFront=function(){i&&i.moveToFront()},this.moveToBack=function(){i&&i.moveToBack()},this.moveForward=function(){i&&i.moveForward()},this.moveBackward=function(){i&&i.moveBackward()},this.setFocus=function(){i&&(i.focus=!0)},this.isFocused=function(){return!!i&&i.focus},this.onKeyDown=function(a){i&&i.onKeyDown!==void 0&&"function"==typeof i.onKeyDown&&i.onKeyDown(a)},this.onKeyUp=function(a){i&&i.onKeyUp!==void 0&&"function"==typeof i.onKeyUp&&i.onKeyUp(a)},this.onChar=function(a){i&&i.onChar!==void 0&&"function"==typeof i.onChar&&i.onChar(a)},this.animateTo=function(a,b,c,d,e){return i?i.animateTo(a,b,c,d,e):new Promise(function(a,b){b("not supported")})},this.animate=function(a,b,c,d,e){if(i)return i.animate(a,b,c,d,e)},this.on=function(a,b){i&&i.on(a,b)},this.api=function(){if(this.type===ApplicationType.WEB)return j;return i?i.api:void 0},this.setProperties=function(a){Object.keys(a).forEach(function(c){if(c.match(/^(id|name|priority)$/g)||0<=Object.keys(b).indexOf(c)){var e=a[c];d.log("set "+c+"="+e),d[c]=e}else d.log("unknown property "+c)})},this.state=function(){return p},"launchParams"in a&&(g=a.launchParams,"cmd"in g&&(k=g.cmd),"uri"in g&&(this.uri=n=g.uri)),"w"in a&&(l=a.w),"h"in a&&(m=a.h),"wpe"===k&&n&&(k=k+" "+n),"serviceContext"in a&&(o=a.serviceContext),this.log("cmd:",k,"uri:",n,"w:",l,"h:",m),k?scene?appManager.getApplicationById(a.id)?(this.log("cannot create app with duplicate ID: "+a.id),f(new Error("duplicate ID: "+a.id)),setTimeout(function(){d.applicationClosed()})):"spark"===k?(this.type=ApplicationType.SPARK,i=scene.create({t:"scene",parent:root,url:n,serviceContext:o}),i.on("onReady",function(){d.log("onReady")}),i.on("onClientStarted",function(){d.log("onClientStarted")}),i.on("onClientConnected",function(){d.log("onClientConnected")}),i.on("onClientDisconnected",function(){d.log("onClientDisconnected")}),i.on("onClientStopped",function(){d.log("onClientStopped")}),i.ready.then(function(){d.log("successfully created Spark app: "+d.id),e(),d.applicationReady()},function a(){d.log("failed to launch Spark app: "+d.id),f(new Error("failed to create")),d.applicationClosed()}),this.setProperties(a),this.applicationCreated()):"sparkInstance"===k?(this.type=ApplicationType.SPARK_INSTANCE,i=scene.create({t:"external",parent:root,cmd:"spark "+n,w:l,h:m,hasApi:!0}),i.on("onReady",function(){d.log("onReady")}),i.on("onClientStarted",function(){d.log("onClientStarted")}),i.on("onClientConnected",function(){d.log("onClientConnected")}),i.on("onClientDisconnected",function(){d.log("onClientDisconnected")}),i.on("onClientStopped",function(){d.log("onClientStopped"),setTimeout(function(){d.destroy()})}),i.ready.then(function(){},function a(){d.log("failed to launch Spark instance app: "+d.id),f(new Error("failed to create")),d.applicationClosed()}),i.remoteReady.then(function(){d.log("spark instance ready"),e(),d.applicationReady()},function a(){d.log("failed to create Spark instance"),f(new Error("failed to create")),d.applicationClosed()}),this.setProperties(a),this.applicationCreated()):"WebApp"===k?(this.type=ApplicationType.WEB,i=scene.create({t:"external",parent:root,server:"wl-rdkbrowser2-server",w:l,h:m,hasApi:!0}),i.remoteReady.then(function(a){a?(d.log("about to create browser window"),j=i.api.createWindow(i.displayName,!1),j?(j.url=n,d.log("launched WebApp uri:"+n),d.applicationCreated(),e(),d.applicationReady()):(d.log("failed to create window for WebApp"),f(new Error("failed to create")),d.applicationClosed())):(d.log("failed to create WebApp invalid waylandObj"),f(new Error("failed to create")),d.applicationClosed())},function a(){d.log("failed to create WebApp"),f(new Error("failed to create")),d.applicationClosed()}),this.setProperties(a)):(this.type=ApplicationType.NATIVE,i=scene.create({t:"external",parent:root,cmd:k,w:l,h:m,hasApi:!0}),i.on("onReady",function(){d.log("onReady")}),i.on("onClientStarted",function(){d.log("onClientStarted")}),i.on("onClientConnected",function(){d.log("onClientConnected")}),i.on("onClientDisconnected",function(){d.log("onClientDisconnected")}),i.on("onClientStopped",function(){d.log("onClientStopped"),setTimeout(function(){d.destroy()})}),i.ready.then(function(){d.log("successfully created: "+d.id),e(),d.applicationReady()},function a(){d.log("failed to launch app: "+d.id),f(new Error("failed to create")),d.applicationClosed()}),this.setProperties(a),this.applicationCreated()):(this.log("cannot create app because the scene is not set"),f(new Error("scene is not set")),setTimeout(function(){d.applicationClosed()})):(this.log("cannot create app because cmd is not set"),f(new Error("cmd is not set")),setTimeout(function(){d.applicationClosed()}))}Application.prototype.log=function(){var a=["optimus"];this.id&&a.push("id="+this.id),this.type&&a.push("type="+this.type),this.state()&&a.push("state="+this.state()),this.name&&a.push("name="+this.name),a.push.apply(a,arguments),console.log.apply(console,a)},Application.prototype.applicationManager=function(){return appManager},Application.prototype.applicationCreated=function(){this.log("applicationCreated"),this.createTime=scene.clock(),appManager.onCreate(this)},Application.prototype.applicationReady=function(){this.log("applicationReady"),appManager.onReady(this);var a=scene.clock()-this.createTime;;console.log("url : "+this.uri+", type : "+this.type+", "+"load time : "+a.toFixed(2)+"ms")},Application.prototype.applicationClosed=function(){this.log("applicationClosed"),appManager.onDestroy(this)},Application.prototype.applicationSuspended=function(){this.log("applicationSuspended"),appManager.onSuspend(this)},Application.prototype.applicationResumed=function(){this.log("applicationResumed"),appManager.onResume(this)},Application.prototype.applicationDestroyed=function(){this.log("applicationDestroyed"),appManager.onDestroy(this)};function Optimus(){function a(a,b){if(a in eventListenerHash)for(var c=eventListenerHash[a],d=0;d<c.length;d++)c[d](b)}this.createApplication=function(a){var b=new Application(a);return applicationsArray.push(b),b},this.getApplications=function(){return applicationsArray},this.getApplicationById=function(a){for(var b=0;b<applicationsArray.length;b++)if(applicationsArray[b].id===a)return applicationsArray[b];return null},this.getAvailableApplications=function(){return availableApplicationsArray},this.on=function(a,b){if(a in eventListenerHash){var c=eventListenerHash[a];c.push(b)}else eventListenerHash[a]=[b]},this.removeListener=function(a,b){if(a in eventListenerHash)if(b)for(var c=eventListenerHash[a],d=c.indexOf(b);-1!==d;)c.splice(d,1),d=c.indexOf(b);else delete eventListenerHash[a]},this.onCreate=function(b){a("create",b)},this.onSuspend=function(b){a("suspend",b)},this.onResume=function(b){a("resume",b)},this.onDestroy=function(b){if(b)for(var c=0;c<applicationsArray.length;c++)if(applicationsArray[c]&&applicationsArray[c].id===b.id){applicationsArray[c]=null,applicationsArray.splice(c,1);break}a("destroy",b)},this.onReady=function(b){a("ready",b)},this.setScene=function(a){scene=a,root=scene.root,availableApplicationsArray.splice(0,availableApplicationsArray.length);var b=scene.getAvailableApplications();0<b.length&&(availableApplicationsArray=JSON.parse(b))}}