'use strict';var isV8="undefined"!=typeof _isV8,http2=isV8?null:require("http2"),https=require("https"),http=require("http"),url=require("url"),EventEmitter=require("events"),Logger=require("rcvrcore/Logger").Logger,log=new Logger("http_wrap");function Module(a,b){this.request=function(c,d){return new Request(a,b,c,d)},this.get=function(c,d){return new Request(a,b,c,d).end()},this.Agent=Agent}module.exports=Module;function Request(a,b,c,d){EventEmitter.call(this),d&&this.once("response",d);var f=this;c=Utils._normalizeOptions(c);var g="http"===a?"http:":"https:",j=Utils._getRequestOrigin(c,g),l=null,m=!1,n=!1,o=null;if(Utils._assert(!!j,"no destination origin"),b&&b.innerscene&&b.innerscene.cors&&(l=b.innerscene.cors.origin),b&&b.innerscene&&b.innerscene.permissions&&!b.innerscene.permissions.allows(j)){this.blocked=n=!0;var p="Permissions block for request to '"+j+"' from '"+l+"'";log.warn(p),setTimeout(function(){log.message(4,"emit 'blocked' delayed after request creation"),f.emit("blocked",new Error(p)),f.removeAllListeners()})}if(b&&b.innerscene&&b.innerscene.cors&&!n&&l){for(var q,e=c.headers?c.headers:c.headers={},h=Object.keys(e),r=0;r<h.length;r++)q=h[r],b.innerscene.cors.isCORSRequestHeader(q)?(log.warn("removing header: '"+q+"'="+e[q]),delete e[q]):b.innerscene.cors.isCredentialsRequestHeader(q)&&(m=!0);log.message(4,"set header: 'Origin'="+l+"'"),e.Origin=l}if(!n){var s="http"===a?http:"https"===a?https:isV8?https:http2;if(isV8&&!c.protocol&&(c.protocol=g),c.agent instanceof Agent){var t=c.agent,u=isV8?null:AgentCache[t.uid]||new s.Agent(t.options);c.agent=AgentCache[t.uid]=u,t.once("destroy",function(){u&&(log.message(4,"destroying the agent"),u.destroy.apply(u,arguments))})}o=s.request.call(null,c),o.once("response",function(a){var c=new Response(a,b,l,j,m);c.blocked?(f.blocked=!0,f.abort(),log.message(4,"emit 'blocked'"),f.emit("blocked",new Error("CORS block for: '"+j+"' from '"+l+"'"))):f.emit("response",c),f.removeAllListeners(),o.removeAllListeners()}),o.once("error",function(a){f.emit("error",a),f.removeAllListeners(),o.removeAllListeners()}),o.once("timeout",function(){f.emit("timeout"),f.removeAllListeners(),o.removeAllListeners()})}this.abort=function(){n||(isV8?o.abort():o.abort.apply(o,arguments))},this.getHeader=function(){if(!n)return isV8?o.getHeader(arguments[0]):o.getHeader.apply(o,arguments)},this.setNoDelay=function(){n||(isV8?log.warn("setNoDelay not implemented for v8"):o.setNoDelay.apply(o,arguments))},this.setSocketKeepAlive=function(){n||(isV8?log.warn("setSocketKeepAlive not implemented for v8"):o.setSocketKeepAlive.apply(o,arguments))},this.setDefaultEncoding=function(){return n||(isV8?log.warn("setSocketKeepAlive not implemented for v8"):o.setDefaultEncoding.apply(o,arguments)),f},this.setTimeout=function(){return n||(isV8?o.setTimeout(arguments[0],arguments[1]):o.setTimeout.apply(o,arguments)),f},this.end=function(){return n||(isV8?o.end():o.end.apply(o,arguments)),f},this.write=function(){if(!n)return isV8?o.write(arguments[0]):o.write.apply(o,arguments)}}Request.prototype=Object.create(EventEmitter.prototype),Request.prototype.constructor=Request,Request.prototype.blocked=!1;function Response(a,b,c,d,e){EventEmitter.call(this);var f=!1,g=Utils._packHeaders(a.headers);if(log.message(4,"response headers: "+g),b&&b.innerscene&&b.innerscene.cors&&!b.innerscene.cors.passesAccessControlCheck(g,e,d)){var h="CORS block for: '"+d+"' from '"+c+"'";log.warn(h),this.blocked=f=!0,"function"==typeof a.end?a.end():"function"==typeof a.destroy&&a.destroy(new Error(h))}else log.message(4,"CORS passed for: '"+d+"' from '"+c+"'");if(!f){var i=this;a.on("data",function(a){i.emit("data",a)}),a.once("error",function(b){i.emit("error",b),i.removeAllListeners(),a.removeAllListeners()}),a.once("end",function(){i.emit("end"),i.removeAllListeners(),a.removeAllListeners()})}this.headers=a.headers,this.httpVersion=a.httpVersion,this.method=a.method,this.rawHeaders=a.rawHeaders,this.rawTrailers=a.rawTrailers,this.statusCode=a.statusCode,this.statusMessage=a.statusMessage,this.trailers=a.trailers,this.url=a.url,this.setEncoding=function(){isV8?log.warn("setEncoding not implemented for v8"):a.setEncoding.apply(a,arguments)}}Response.prototype=Object.create(EventEmitter.prototype),Response.prototype.constructor=Response,Response.prototype.blocked=!1;function Agent(a){EventEmitter.call(this),this.setMaxListeners(1/0),log.message(4,"creating a new agent"),this.options=a,this.uid=Math.floor(1e5+9e5*Math.random());var b=this;this.destroy=function(){log.message(4,"emit agent 'destroy'"),b.emit("destroy")}}Agent.prototype=Object.create(EventEmitter.prototype),Agent.prototype.constructor=Agent;var AgentCache={};function Utils(){}Utils._normalizeOptions=function(a){return a="string"==typeof a?url.parse(a):Utils._extend({},a),a},Utils._packHeaders=function(a){var b="";return Object.keys(a).forEach(function(c){b+="\r\n"+c+": "+a[c]}),b.slice(2)},Utils._getRequestOrigin=function(a,b){var c=Utils._getRequestScheme(a,b),d=a.hostname||a.host||"localhost",e=1<(d.match(/:/g)||[]).length;d=e?"["+d+"]":d;var f=a.port?":"+a.port:"";return c+"//"+d+f},Utils._extend=function(a,b){if(null===b||"object"!=typeof b)return a;for(var c=Object.keys(b),d=c.length;d--;)a[c[d]]=b[c[d]];return a},Utils._assert=function(a,b){if(!a)throw log.warn(b),new Error(b)},Utils._getRequestScheme=function(a,b){var c=a.protocol?a.protocol:b;return c.toLowerCase()};