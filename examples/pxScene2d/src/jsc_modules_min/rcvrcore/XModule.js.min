"use strict";var hasExtension=require("rcvrcore/utils/FileUtils").hasExtension,Logger=require("rcvrcore/Logger").Logger,log=new Logger("XModule");function XModule(a,b,c,d){log.message(5,"Create new XModule for "+a),this.name=a,this.appSandbox=null,this.moduleReadyPromise=null,this.exports={},this.appSceneContext=b,this.log=null,this.basePath=c,this.jarName=d,this.importReplacementMap={}}XModule.prototype.freeResources=function(){this.name=null,this.appSandbox=null,this.moduleReadyPromise=null,this.exports=null,this.appSceneContext=null,this.log=null,this.basePath=null,this.jarName=null,this.importReplacementMap=null},XModule.prototype.getBasePath=function(){return this.basePath},XModule.prototype.getJarName=function(){return this.jarName},XModule.prototype.initSandbox=function(a){this.appSandbox=a,this.log=new Logger(this.name)},XModule.prototype.importModule=function(a){var b=this;return new Promise(function(c,d){var e,f,g=!1,h={},i=[];if("string"==typeof a)i.push(a),g=!0;else if(!Array.isArray(a)){for(f in a)if(a.hasOwnProperty(f)){var j=a[f];i.push(j),h[j]=f}}else for(e=0;e<a.length;++e)f=a[e],i.push(f),h[f]=f.substring(f.lastIndexOf("/")+1);if(0===i.length)return log.message(5,"XModule:  No includes are required for "+b.name),c(),void(b.moduleReadyPromise=null);var l;if(l=hasExtension(b.name,".js")?b.name.substring(0,b.name.lastIndexOf(".js")):b.name,b.appSandbox&&b.appSandbox.importTracking)for(b.appSandbox.importTracking.hasOwnProperty(l)||(b.appSandbox.importTracking[l]=[]),e=0;e<i.length;++e)log.message(9,l+" REQUIRES "+i[e]),b.appSandbox.importTracking[l].push(i[e]);b.moduleReadyPromise=new Promise(function(a,e){var f,j,m=[],n=[];for(f=0;f<i.length;++f){j=i[f];var o=b.appSceneContext.include(j,b);m[f]=j,n[f]=o}Promise.all(n).then(function(d){var e={};if(g)j=d[0][1],log.message(9,l+" GOT "+j),e=d[0][0];else for(f=0;f<m.length;++f)j=h[d[f][1]],log.message(9,l+" GOT "+j),e[j]=d[f][0];delete b.appSandbox.importTracking[l],log.message(7,"XMODULE ABOUT TO NOTIFY ["+b.name+"] that all its imports are Ready"),c(e),a(),log.message(8,"XMODULE AFTER NOTIFY ["+b.name+"] that all its imports are Ready")}).catch(function(a){log.error("Error - failed to get Remote modules for: "+b.name+", error="+a),d(),e(a)})})})},XModule.prototype.configImport=function(a){this.importReplacementMap=a},XModule.prototype.findImportReplacementMatch=function(a){if(null===this.importReplacementMap)return null;for(var b in this.importReplacementMap){var c=new RegExp("^"+b);if(a.match(c)){var d=a.replace(c,this.importReplacementMap[b]);return{fileUri:d,isJarFile:!1}}}return null},XModule.prototype.getFile=function(a){return this.appSceneContext.getModuleFile(a,this)},XModule.prototype.resolveFilePath=function(a){return this.appSceneContext.resolveModulePath(a,this)},module.exports=XModule;