var isDuk="undefined"!=typeof Duktape,isV8="undefined"!=typeof _isV8,isJSC="undefined"!=typeof _isJSC,url=require("url"),path=require("path"),vm=require("vm"),Logger=require("rcvrcore/Logger").Logger,SceneModuleLoader=require("rcvrcore/SceneModuleLoader"),XModule=require("rcvrcore/XModule"),loadFile=require("rcvrcore/utils/FileUtils").loadFile,SceneModuleManifest=require("rcvrcore/SceneModuleManifest"),JarFileMap=require("rcvrcore/utils/JarFileMap"),AsyncFileAcquisition=require("rcvrcore/utils/AsyncFileAcquisition"),WrapObj=require("rcvrcore/utils/WrapObj"),http_wrap=require("rcvrcore/http_wrap"),log=new Logger("AppSceneContext"),SetTimeout=isDuk||isV8?timers.setTimeout:setTimeout,ClearTimeout=isDuk||isV8?timers.clearTimeout:clearTimeout,SetInterval=isDuk||isV8?timers.setInterval:setInterval,ClearInterval=isDuk||isV8?timers.clearInterval:clearInterval,console=isDuk||isV8||isJSC?global.console:require("console_wrap");function AppSceneContext(a){if(this.getContextID=a.getContextID,this.makeReady=a.makeReady,this.innerscene=a.scene,this.rpcController=a.rpcController,-1!==a.packageUrl.indexOf("?")){var b=url.parse(a.packageUrl,!0);this.queryParams=b.query,this.packageUrl=a.packageUrl}else this.queryParams={},this.packageUrl=a.packageUrl;this.defaultBaseUri="",this.basePackageUri="",this.sandbox={},this.scriptMap={},this.xmoduleMap={},this.asyncFileAcquisition=new AsyncFileAcquisition(a.scene),this.lastHrTime=isDuk?uv.hrtime():isV8||isJSC?uv_hrtime():process.hrtime(),this.resizeTimer=null,this.topXModule=null,this.jarFileMap=new JarFileMap,this.sceneWrapper=null,this.timers=[],this.timerIntervals=[],this.webSocketManager=null,this.disableFilePermissionCheck=!!isV8||this.innerscene.sparkSetting("disableFilePermissionCheck"),null==this.disableFilePermissionCheck&&(this.disableFilePermissionCheck=!1),this.isCloseEvtRcvd=!1,this.isTermEvtRcvd=!1,this.termEvent=null,log.message(4,"[[[NEW AppSceneContext]]]: "+this.packageUrl)}AppSceneContext.prototype.loadScene=function(){function a(){this.termEvent;null!=this.webSocketManager&&(this.webSocketManager.clearConnections(),delete this.webSocketManager),this.webSocketManager=null;for(var a=this.timers.length,b=0;b<a;b++)clearTimeout(this.timers.pop());for(var c=this.timerIntervals.length,b=0;b<c;b++)clearInterval(this.timerIntervals.pop());if(void 0!==this.innerscene.api)for(var d in this.innerscene.api)delete this.innerscene.api[d];if(null!=this.innerscene&&null!=this.innerscene&&(this.innerscene.api=null),this.innerscene=null,this.sandbox){for(var d in this.sandbox.sandboxName=null,this.sandbox.console=null,this.sandbox.process=null,this.sandbox.theNamedContext=null,this.sandbox.Buffer=null,this.sandbox.require=null,this.sandbox.global=null,this.sandbox.setTimeout=null,this.sandbox.setInterval=null,this.sandbox.clearTimeout=null,this.sandbox.clearInterval=null,this.sandbox.importTracking)delete this.sandbox.importTracking[d];for(var d in this.sandbox.importTracking=null,this.sandbox)delete this.sandbox[d]}for(var e in this.sandbox=null,this.xmoduleMap)this.xmoduleMap[e].freeResources(),delete this.xmoduleMap[e];for(var f in this.xmoduleMap=null,this.asyncFileAcquisition&&(this.asyncFileAcquisition.scene=null,this.asyncFileAcquisition=null),null!=this.topXModule&&this.topXModule.freeResources(),this.topXModule=null,this.jarFileMap=null,this.scriptMap)this.scriptMap[f].scriptObject=null,this.scriptMap[f].readyListeners=null,delete this.scriptMap[f];this.scriptMap=null,null!=this.sceneWrapper&&this.sceneWrapper.close(),this.sceneWrapper=null,this.rpcController=null,this.isCloseEvtRcvd=!1,this.isTermEvtRcvd=!1,this.termEvent=null}var b=this.packageUrl.split("?")[0],c=url.parse(b,!0),d=b,e=isDuk?uv.platform:isV8||isJSC?uv_platform():process.platform;"http"===d.substring(0,4)?this.basePackageUri=d.substring(0,d.lastIndexOf("/")):("."===d.charAt(0)?this.defaultBaseUri=".":"win32"===e&&":"===d.charAt(1)&&(c.pathname=b),d=c.pathname,null!==d&&(this.basePackageUri=d.substring(0,d.lastIndexOf("/")))),null!==d&&this.loadPackage(d),this.innerscene.on("onSceneTerminate",function(b){this.isTermEvtRcvd=!0,this.termEvent=b,!0==this.isCloseEvtRcvd&&a.bind(this)()}.bind(this)),this.innerscene.on("onClose",function(){!0==this.isTermEvtRcvd&&a.bind(this)(),this.isCloseEvtRcvd=!0}.bind(this))},AppSceneContext.prototype.loadPackage=function(a){var b=this,c=new SceneModuleLoader,d=this.makeReady;c.loadScenePackage(this.innerscene,{fileUri:a}).then(function(){if(c.isDefaultManifest())b.getFile("package.json").then(function(d){var e=new SceneModuleManifest;e.loadFromJSON(d),b.runScriptInNewVMContext(a,c,e.getConfigImport())}).catch(function(){b.runScriptInNewVMContext(a,c,null)});else{var d=c.getManifest();b.runScriptInNewVMContext(a,c,d.getConfigImport())}}).catch(function(a){d(!1,{}),console.error("AppSceneContext#loadScenePackage: Error: Did not load fileArchive: Error=",a)})};var setTimeoutCallback=function(){var a=arguments[0],b=arguments[1];b(),b=null;var c=a.indexOf(this);-1!=c&&a.splice(c,1),ClearTimeout(this)};function getBaseFilePath(){return this}function createModule_pxScope(a,b){var c={log:a.log,import:a.importModule.bind(a),configImport:a.configImport.bind(a),resolveFilePath:a.resolveFilePath.bind(a),appQueryParams:this.queryParams,getPackageBaseFilePath:this.getPackageBaseFilePath.bind(this),getFile:this.getFile.bind(this),getModuleFile:a.getFile.bind(a)};return c.getBaseFilePath=!0==b?""==a.basePath?getBaseFilePath.bind("./"):getBaseFilePath.bind(a.basePath+"/"):c.getPackageBaseFilePath,c}AppSceneContext.prototype.runScriptInNewVMContext=function(a,b,c){var d,e,f=this,g=b.jarFileWasLoaded(),h=b.getFileArchive(),i=b.getManifest(),j=i.getMain(),k=h.getFileContents(j),l=j,m=url.parse(j,!0),n=m.pathname,o=j;g?(d=j.substring(0,j.lastIndexOf("/")),e=n):d=a.substring(0,a.lastIndexOf("/"));var p=this;log.message(4,"runScriptInNewVMContext: create XModule("+n+") basePath="+d+" packageUri="+a);var q=new XModule(n,this,d,e);this.topXModule=q,null!==c&&q.configImport(c),g&&(this.jarFileMap.addArchive(q.name,h),log.message(4,"JAR added: "+q.name));var r,s=this;try{if(!isDuk&&!isV8&&!isJSC){var t=function(a){return"function"==typeof requireIt?(log.message(1,"old use of require not supported: "+a),requireIt(a)):void log.message(1,"old use of require not supported: "+a)},u=process.env.PXSCENE_REQUIRE_ENABLE_FILE_PATH,v="/tmp/";process.env.HOME&&""!==process.env.HOME&&(v=process.env.HOME),u&&""!==u&&(v=u);var w=require("fs"),x=v+"/.pxsceneEnableRequire";w&&w.existsSync(x)&&(console.log("enabling pxscene require support"),t=require)}if(!isDuk&&!isV8&&!isJSC){var y=WrapObj(process,{binding:function(){throw new Error("process.binding is not supported")}}),z=WrapObj(global,{process:y});r={sandboxName:"InitialSandbox",console:console,theNamedContext:"Sandbox: "+o,Buffer:Buffer,process:y,require:t,global:z,setTimeout:function(a,b,c,d,e){var f=SetTimeout(setTimeoutCallback,b,this.timers,function(){a(c,d,e)});return this.timers.push(f),f}.bind(this),clearTimeout:function(a){var b=this.timers.indexOf(a);-1!=b&&this.timers.splice(b,1),ClearTimeout(a)}.bind(this),setInterval:function(a,b,c,d,e){var f=SetInterval(a,b,c,d,e);return this.timerIntervals.push(f),f}.bind(this),clearInterval:function(a){var b=this.timerIntervals.indexOf(a);-1!=b&&this.timerIntervals.splice(b,1),ClearInterval(a)}.bind(this),importTracking:{}}}else r=isV8?{sandboxName:"InitialSandbox",console:console,timers:timers,global:global,isV8:isV8,setTimeout:setTimeout,clearTimeout:clearTimeout,setInterval:setInterval,clearInterval:clearInterval,require:require,loadUrl:loadUrl,theNamedContext:"Sandbox: "+o,importTracking:{},print:print,getScene:getScene,makeReady:makeReady,getContextID:getContextID}:isJSC?{sandboxName:"InitialSandbox",console:console,global:global,isJSC:isJSC,setTimeout:setTimeout,clearTimeout:clearTimeout,setInterval:setInterval,clearInterval:clearInterval,require:require,loadUrl:loadUrl,theNamedContext:"Sandbox: "+o,importTracking:{},print:print,getScene:getScene,makeReady:makeReady,getContextID:getContextID}:{sandboxName:"InitialSandbox",console:console,theNamedContext:"Sandbox: "+o,importTracking:{}};q.initSandbox(r),p.sandbox=r;try{var A=AppSceneContext.wrap(k);log.message(4,"createModule_pxScope.call()");var B=createModule_pxScope.call(this,q);log.message(4,"createModule_pxScope.call() done");var C=WrapObj(q,{appSceneContext:WrapObj(q.appSceneContext,{packageUrl:q.appSceneContext.packageUrl},!0,["getPackageBaseFilePath","getFile"])},!0,["exports"]);if(isDuk||isJSC)vm.runInNewContext(A,r,{filename:path.normalize(l),displayErrors:!0},B,C,l,this.basePackageUri);else if(isV8){var D=vm.runInNewContext(A,r,{filename:path.normalize(l),displayErrors:!0},B,C,l,this.basePackageUri);D(B,C,l,this.basePackageUri)}else{var D=vm.runInNewContext(A,r,{filename:path.normalize(l),displayErrors:!0});if(process._debugWaitConnect){1!=process.env.BREAK_ON_SCRIPTSTART&&delete process._debugWaitConnect;const a=vm.runInDebugContext("Debug");a.setBreakPoint(D,0,0)}D(B,C,l,this.basePackageUri)}log.message(4,"vm.runInNewContext done"),q.hasOwnProperty("moduleReadyPromise")&&null!==q.moduleReadyPromise?q.moduleReadyPromise.then(function(){s.innerscene.api=q.exports,s.makeReady(!0,q.exports)}).catch(function(a){console.error("Main module["+s.packageUrl+"] load has failed - on failed imports: , err="+a),s.makeReady(!1,{})}):(s.innerscene.api=q.exports,this.makeReady(!0,q.exports))}catch(a){console.error("failed to run app:"+o),console.error(a),scene.url="",f.destroyScene(sandbox.scene),sandbox.console=null,sandbox.scene=null,sandbox.runtime=null,sandbox.process=null}}catch(a){console.error("failed to load script:"+o+"; error="+a),console.error(a)}},AppSceneContext.prototype.getPackageBaseFilePath=function(){var a,b,c=isDuk?uv.platform:isV8||isJSC?uv_platform():process.platform;return"http"===this.basePackageUri.substring(0,4)?a=this.basePackageUri:(b="."==this.basePackageUri.charAt(0)?this.basePackageUri.substring(1):this.basePackageUri,a="/"==b.charAt(0)?this.defaultBaseUri+b:"win32"===c&&":"===b.charAt(1)?b:this.defaultBaseUri+"/"+b),a=a.replace("%20"," "),a},AppSceneContext.prototype.getModuleFile=function(a,b){var c=this.jarFileMap.getArchiveFileAsync(b.getJarName(),a);if(c)return log.message(4,"Found file '"+a+"' in JAR: "+b.getJarName()),c;var d;return d=this.resolveModulePath(a,b),log.message(3,"TJC: getModuleFile("+a+"): resolves to "+d.fileUri),this.getFile(d.fileUri)},AppSceneContext.prototype.getFile=function(a){return log.message(4,"getFile: requestedFile="+a),"true"===this.disableFilePermissionCheck||!0===this.disableFilePermissionCheck?loadFile(a):loadFile(a,this)},AppSceneContext.prototype.resolveModulePath=function(a,b){var c=b.findImportReplacementMatch(a);if(null===c&&this.topXModule!==b&&(c=this.topXModule.findImportReplacementMatch(a)),null!==c)return log.info(a+" ==> "+c.fileUri),c;var d;return"/"==a.charAt(0)?(d=a.substring(1),this.basePackageUri&&(d=url.resolve(this.basePackageUri+"/",d))):(d=a,b.getBasePath()&&(d=url.resolve(b.getBasePath()+"/",d))),{fileUri:d}},AppSceneContext.prototype.include=function(a,b){log.message(4,">>> include("+a+") for "+b.name+" <<<");var c=this,d=a;return new Promise(function(e,f){if(/^(px|url|querystring|htmlparser|crypto|oauth)$/.test(a)){if(isDuk&&"htmlparser"===a)return console.log("Not permitted to use the module "+a),void f("include failed due to module not permitted");var g=require(a);return void e([g,d])}if("fs"===a||"os"===a||"events"===a)return console.log("Not permitted to use the module "+a),void f("include failed due to module not permitted");if("ws"===a){if(isDuk)return console.log("creating websocket instance"),g=websocket,void e([g,d]);var h=require("rcvrcore/ws_wrap");c.webSocketManager=new h;var i=function(){var a=this;return function(b,c,d){var e=a.webSocketManager.WebSocket(b,c,d);return e}}.bind(c)();return g=i,void e([g,d])}if(/^(http|https|http2)$/.test(a))return g=new http_wrap(a,c),void e([g,d]);if("px:scene."===a.substring(0,9)){var j=require("rcvrcore/"+a.substring(3));return null===c.sceneWrapper&&(c.sceneWrapper=new j),c.sceneWrapper._setNativeScene(c.innerscene,b.name),c.sceneWrapper._setRPCController(c.rpcController),void e([c.sceneWrapper,d])}if("px:tools."===a.substring(0,9))return g=require("rcvrcore/tools/"+a.substring(9)),void e([g,d]);if("optimus"===a.substring(0,7))return g=require("rcvrcore/optimus.js"),void e([g,d]);if(a=c.resolveModulePath(a,b).fileUri,log.message(4,"filePath="+a),c.isScriptDownloading(a))return log.message(4,"Script is downloading for "+a),void c.addModuleReadyListener(a,function(a){e([a,d])});if(c.isScriptLoaded(a))return log.message(4,"Already have file loaded and ready, just return the existing content: "+a),g=c.getScriptContents(a),void e([g,d]);c.setScriptStatus(a,"downloading");var k=c.jarFileMap.getArchiveFile(b.getJarName(),a);if(k){log.message(4,"Found file '"+a+"' in JAR: "+b.getJarName());var l=new SceneModuleLoader;return l.processFileData(a,k),l.loadedJarFile=!1,l.manifest=new SceneModuleManifest,l.manifest.loadFromJSON(l.getFileArchive().getFileContents("package.json")),void c.processCodeBuffer(d,a,b,l,e,f)}c.asyncFileAcquisition.acquire(a).then(function(g){log.message(4,"PROCESS RCVD MODULE: "+a),c.processCodeBuffer(d,a,b,g,e,f)}).catch(function(b){console.error("Error: could not load file ",a,", err=",b),f("include failed")})})},AppSceneContext.prototype.processCodeBuffer=function(a,b,c,d,e,f){var g=this;if(g.isScriptReady(b)){var h=g.getScriptContents(b);return void e([h,a])}if(g.isScriptLoaded(b))return log.message(4,"It looks like module script is already loaded -- no need to run it"),void g.addModuleReadyListener(b,function(b){log.message(7,"Received moduleExports from other download"),e([b,a])});log.message(4,"Need to run script: "+b);var i=this.getXModule(b);if("undefined"!==i)return void log.message(4,"xModule already exists: "+b);var j,k,l=d.jarFileWasLoaded(),m=d.getFileArchive(),n=d.getManifest(),o=n.getMain(),p=m.getFileContents(o);l?(j=o.substring(0,o.lastIndexOf("/")),k=b):(j=b.substring(0,b.lastIndexOf("/")),k=c.getJarName()),log.message(7,"cb Creating new XModule for "+b+" basePath="+j),i=new XModule(b,g,j,k),i.initSandbox(g.sandbox),l&&(g.jarFileMap.addArchive(i.name,m),log.message(4,"JAR added: "+i.name));var q=AppSceneContext.wrap(p);log.message(4,"RUN "+b);var r=createModule_pxScope.call(this,i,!0),s=WrapObj(i,{appSceneContext:WrapObj(i.appSceneContext,{packageUrl:i.appSceneContext.packageUrl},!0,["getPackageBaseFilePath","getFile"])},!0,["exports"]);if(isDuk||isJSC)vm.runInNewContext(q,g.sandbox,{filename:b,displayErrors:!0},r,s,b,b);else if(isV8||isJSC){var t=vm.runInNewContext(q,g.sandbox,{filename:b,displayErrors:!0},r,s,b,b);t(r,s,b,b)}else{var t=vm.runInContext(q,g.sandbox,{filename:b,displayErrors:!0});t(r,s,b,b)}log.message(4,"RUN DONE: "+b),this.setXModule(b,i),i.moduleReadyPromise?i.moduleReadyPromise.then(function(){log.message(4,"["+i.name+"]: <"+b+"> MODULE INDICATES IT'S FULLY READY. xModule.exports:"+typeof i.exports),g.addScript(b,"loaded",i.exports),g.setScriptStatus(b,"ready"),log.message(4,"is about to notify ["+c.name+"] that <"+b+"> has been imported and is ready"),e([i.exports,a]),log.message(4,"after notifying [:"+c.name+"] about import <"+b+">"),g.callModuleReadyListeners(b,i.exports)}).catch(function(a){f("include(2): failed while waiting for module <"+b+"> to be ready for ["+c.name+"] - error="+a)}):(log.message(4,"["+i.name+"]: <"+b+"> MODULE INDICATES IT'S FULLY READY. xModule.exports:"+typeof i.exports),g.addScript(b,"ready",i.exports),log.message(4,"is about to notify ["+c.name+"] that <"+b+"> has been imported and is ready"),e([i.exports,a]),log.message(4,"after notifying [:"+c.name+"] about import <"+b+">"),g.callModuleReadyListeners(b,i.exports))},AppSceneContext.prototype.onResize=function(a){var b=isDuk?uv.hrtime():isV8||isJSC?uv_hrtime():process.hrtime(this.lastHrTime),c=1e3*b[0]+b[1]/1e6;if(this.lastHrTime=isDuk?uv.hrtime():isV8||isJSC?uv_hrtime():process.hrtime(),300<c)null!==this.resizeTimer&&(clearTimeout(this.resizeTimer),this.resizeTimer=null);else{var d=a.w,e=a.h;this.resizeTimer=setTimeout(function(){}.bind(this),500)}},AppSceneContext.prototype.addModuleReadyListener=function(a,b){this.scriptMap.hasOwnProperty(a)?this.scriptMap[a].readyListeners.push(b):console.trace("AppSceneContext#addModuleReadyListener: no entry in map for module ["+a+"]")},AppSceneContext.prototype.callModuleReadyListeners=function(a,b){if(log.message(4,"Call ModuleReadyListeners for module: "+a),this.scriptMap.hasOwnProperty(a)){var c=this.scriptMap[a].readyListeners;if(null!==c&&0!==c.length){for(var d=0;d<c.length;++d)c[d](b);for(var d=0;d<c.length;++d)c.pop()}this.scriptMap[a].readyListeners=null}else console.trace("AppSceneContext#callModuleReadyListeners: no entry in map for module ["+a+"]")},AppSceneContext.prototype.setXModule=function(a,b){this.xmoduleMap[a]=b},AppSceneContext.prototype.getXModule=function(a){return this.xmoduleMap.hasOwnProperty(a)?this.xmoduleMap[a].xmod:"undefined"},AppSceneContext.prototype.addScript=function(a,b,c){if(this.scriptMap.hasOwnProperty(a)){var d=this.scriptMap[a];d.status=b,"ready"==b&&("undefined"==typeof c||null===c)&&console.trace("Whoa: seting Ready state but there is no scriptObject"),null!==c&&"undefined"!==c&&(d.scriptObject=c,log.message(4,"ADDED UPDATED script: "+a+", status="+b));var e=this.scriptMap[a].scriptObject;null===e&&null!==c&&console.trace("Script object changing from null, but isn't being set"),log.message(8,"AddScript "+a+", status="+b+", object="+typeof c)}else this.scriptMap[a]={status:b,scriptObject:c,readyListeners:[]},log.message(4,"ADDED NEW script: "+a+", status="+b)},AppSceneContext.prototype.getScriptContents=function(a){return this.scriptMap.hasOwnProperty(a)?this.scriptMap[a].scriptObject:null},AppSceneContext.prototype.setScriptStatus=function(a,b){if(this.scriptMap.hasOwnProperty(a)){this.scriptMap[a].status=b;var c=this.scriptMap[a].scriptObject;"ready"==b&&("undefined"==typeof c||null===c)&&console.trace("Whoa: seting Ready state but there is no scriptObject"),log.message(8,"1) SetScriptStatus "+a+", status="+b+", object="+typeof c)}else log.message(8,"0) SetScriptStatus "+a+", status="+b+", null"),this.addScript(a,b,null)},AppSceneContext.prototype.getScriptStatus=function(a){return this.scriptMap.hasOwnProperty(a)?this.scriptMap[a].status:"undefined"},AppSceneContext.prototype.isScriptDownloading=function(a){return this.scriptMap.hasOwnProperty(a)&&"downloading"===this.scriptMap[a].status?(log.message(4,"isScriptDownloading("+a+")? Yes"),!0):(log.message(4,"isScriptDownloading("+a+")? NOT DOWNLOADED YET"),!1)},AppSceneContext.prototype.isScriptLoaded=function(a){return this.scriptMap.hasOwnProperty(a)&&("loaded"===this.scriptMap[a].status||"ready"===this.scriptMap[a].status)?(log.message(4,"isScriptLoaded("+a+")? Yes"),!0):(log.message(4,"isScriptLoaded("+a+")? NOT LOADED YET"),!1)},AppSceneContext.prototype.isScriptReady=function(a){return this.scriptMap.hasOwnProperty(a)&&"ready"===this.scriptMap[a].status?(log.message(4,"isScriptReady("+a+")?  Yes it's READY"),!0):(log.message(4,"isScriptReady("+a+")?  NOT READY YET"),!1)},AppSceneContext.wrap=function(a){return AppSceneContext.wrapper[0]+a+AppSceneContext.wrapper[1]},AppSceneContext.wrapper=["(function (px, module, __filename, __dirname) { ","\n});"],module.exports=AppSceneContext;